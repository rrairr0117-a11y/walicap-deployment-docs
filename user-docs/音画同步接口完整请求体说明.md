# 音画同步接口完整请求体说明文档

## 📋 接口信息

**接口路径：** `/v1/video/sync-audio-video`  
**请求方法：** `POST`  
**Content-Type：** `application/json`  
**认证方式：** `X-API-Key` 请求头

---

## 🎯 功能概述

该接口实现以下功能：
1. **音画同步**：自动调整视频速度以匹配音频长度
2. **音频合成**：将新音频与原视频音频混合
3. **字幕生成**：支持自动识别、翻译、双语字幕
4. **ASS 特效**：支持背景框、发光效果、多种字幕样式
5. **云端存储**：自动上传到 MinIO/S3

---

## 📝 完整请求体示例

### **示例 1: 金色文字 + 白色发光效果（带详细注释）**

```json
{
  // ==================== 视频配置 ====================
  "video": {
    "url": "http://minio-local:9000/bucket/video.mp4"  // 视频文件 URL（支持 HTTP/MinIO/S3）
  },
  
  // ==================== 音频配置 ====================
  "audio": {
    "url": "http://minio-local:9000/bucket/audio.wav"  // 音频文件 URL（WAV/MP3/AAC 等格式）
  },
  
  // ==================== 音频混合配置 ====================
  "keep_original_audio": true,           // 是否保留原视频音频（true=混合，false=替换）
  "original_audio_volume": 0.3,          // 原音频音量（0.0-2.0，0.3=30%音量，常用于背景音乐）
  "new_audio_volume": 1.0,               // 新音频音量（0.0-2.0，1.0=原始音量，常用于配音）
  
  // ==================== 硬件加速 ====================
  "use_nvidia": true,                    // 是否使用 NVIDIA GPU 加速（true=快速，false=CPU 处理）
  
  // ==================== 字幕配置 ====================
  "subtitle": {
    // ---------- 基础配置 ----------
    "enabled": true,                     // 是否启用字幕（true=生成字幕，false=不生成）
    "mode": "manual",                    // 字幕模式（"auto"=自动识别，"manual"=手动提供）
    "srt_content": "1\n00:00:00,000 --> 00:00:05,000\n这是测试字幕",  // SRT 字幕内容（mode=manual 时必填）
    "translate_manual_srt": true,        // 是否翻译手动提供的 SRT（true=翻译，false=不翻译）
    "target_lang": "th",                 // 目标语言（"th"=泰语，"en"=英语，"ja"=日语等）
    "subtitle_language": "zh",           // 字幕原始语言（"zh"=中文，"en"=英语等）
    "subtitle_task": "bilingual",        // 字幕任务（"transcribe"=单语，"translate"=翻译，"bilingual"=双语）
    "subtitle_engine": "whisper",        // 字幕识别引擎（"whisper"=OpenAI Whisper，"funasr"=阿里 FunASR）
    
    // ---------- 字幕样式 ----------
    "style": "classic",                  // 字幕样式（"classic"=经典，"karaoke"=卡拉OK，"highlight"=高亮等）
    "font_name": "KingHwa_OldSong",      // 字体名称（"KingHwa_OldSong"=京华老宋体，"Arial"=Arial 等）
    "font_size": 28,                     // 字体大小（像素，12-200，推荐 28-48）
    "primary_color": "#FFD700",          // 文字颜色（RGB 格式，"#FFD700"=金黄色，"#FFFFFF"=白色）
    "outline_color": "#000000",          // 描边颜色（RGB 格式，"#000000"=黑色，增强对比度）
    "outline_width": 2,                  // 描边宽度（像素，0-10，推荐 2-3）
    "shadow_offset": 0,                  // 阴影偏移（像素，0=无阴影，2-4=轻微阴影）
    
    // ---------- 文字格式 ----------
    "bold": true,                        // 是否加粗（true=加粗，false=正常）
    "italic": false,                     // 是否斜体（true=斜体，false=正常）
    "underline": false,                  // 是否下划线（true=下划线，false=无）
    "strikeout": false,                  // 是否删除线（true=删除线，false=无）
    
    // ---------- 发光效果（动漫风格）----------
    "glow_color": "#FFFFFF",             // 发光颜色（RGB 格式，"#FFFFFF"=白色发光，"#FF1493"=粉红发光）
    "glow_strength": 4,                  // 发光强度（0-10，0=不发光，3-5=中等，7-10=强烈）
    
    // ---------- 背景框效果（与发光互斥）----------
    "box_color": "#000000",              // 背景框颜色（RGB 格式，"#FFFF00"=黄色，"#000000"=黑色）
    "box_opacity": 0,                    // 背景框不透明度（0.0-1.0，0=不显示，0.6=半透明，1.0=不透明）
    "box_padding": 8,                    // 背景框边距（像素，0-50，推荐 8-12）
    
    // ---------- 位置配置 ----------
    "position": "bottom_center",         // 字幕位置（"bottom_center"=底部居中，"top_center"=顶部居中等）
    "margin_v": 80,                      // 垂直边距（像素，距离屏幕边缘的距离，推荐 50-100）
    "effect": "classic"                  // 特效样式（"classic"=经典，"karaoke"=卡拉OK）
  },
  
  // ==================== 输出配置 ====================
  "output": {
    "cloud_upload": true,                // 是否上传到云端（true=上传到 MinIO/S3，false=仅本地）
    "filename": "synced_video_20241206.mp4"  // 输出文件名（支持变量，如时间戳）
  }
}
```

**⚠️ 注意：JSON 不支持注释！** 实际使用时请删除所有注释（`//` 开头的部分）。

### **示例 2: 黄色背景框效果**

```json
{
  "video": {
    "url": "http://minio-local:9000/bucket/video.mp4"
  },
  "audio": {
    "url": "http://minio-local:9000/bucket/audio.wav"
  },
  "keep_original_audio": false,
  "new_audio_volume": 1.0,
  "use_nvidia": true,
  "subtitle": {
    "enabled": true,
    "mode": "auto",
    "subtitle_language": "zh",
    "subtitle_task": "transcribe",
    "subtitle_engine": "whisper",
    
    "style": "classic",
    "font_name": "Arial",
    "font_size": 48,
    "primary_color": "#000000",
    "outline_color": "#000000",
    "outline_width": 2,
    
    "bold": false,
    "italic": false,
    
    "box_color": "#FFFF00",
    "box_opacity": 0.6,
    "box_padding": 10,
    
    "glow_color": null,
    "glow_strength": 0,
    
    "position": "bottom_center",
    "margin_v": 50,
    "effect": "classic"
  },
  "output": {
    "cloud_upload": true,
    "filename": "output.mp4"
  }
}
```

### **示例 3: 卡拉OK 效果**

```json
{
  "video": {
    "url": "http://minio-local:9000/bucket/video.mp4"
  },
  "audio": {
    "url": "http://minio-local:9000/bucket/audio.wav"
  },
  "keep_original_audio": true,
  "original_audio_volume": 0.5,
  "new_audio_volume": 1.0,
  "use_nvidia": true,
  "subtitle": {
    "enabled": true,
    "mode": "manual",
    "srt_content": "1\n00:00:00,000 --> 00:00:05,000\n卡拉OK测试",
    "translate_manual_srt": false,
    "target_lang": "zh",
    
    "style": "karaoke",
    "font_name": "Noto Sans CJK SC",
    "font_size": 52,
    "primary_color": "#FFFFFF",
    "outline_color": "#000000",
    "outline_width": 3,
    
    "bold": true,
    "italic": false,
    
    "glow_color": "#FF1493",
    "glow_strength": 5,
    
    "position": "bottom_center",
    "margin_v": 100,
    "effect": "karaoke"
  },
  "output": {
    "cloud_upload": true,
    "filename": "karaoke_output.mp4"
  }
}
```

---

## 📚 参数详细说明

### **1. 视频配置 (`video`)**

| 参数 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| `url` | string | ✅ 是 | 视频文件的 URL（支持 HTTP/MinIO） | `"http://minio-local:9000/bucket/video.mp4"` |
| `bucket` | string | 可选 | S3 存储桶名称（与 `key` 配合使用） | `"my-bucket"` |
| `key` | string | 可选 | S3 对象键（与 `bucket` 配合使用） | `"videos/input.mp4"` |

**注意：** `url` 和 `bucket+key` 二选一。

---

### **2. 音频配置 (`audio`)**

| 参数 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| `url` | string | ✅ 是 | 音频文件的 URL | `"http://minio-local:9000/bucket/audio.wav"` |
| `bucket` | string | 可选 | S3 存储桶名称 | `"my-bucket"` |
| `key` | string | 可选 | S3 对象键 | `"audios/voice.wav"` |

---

### **3. 音频混合配置**

| 参数 | 类型 | 必填 | 默认值 | 说明 | 示例 |
|------|------|------|--------|------|------|
| `keep_original_audio` | boolean | 否 | `false` | 是否保留原视频音频 | `true` |
| `original_audio_volume` | number | 否 | `0.3` | 原音频音量（0.0-2.0） | `0.3` |
| `new_audio_volume` | number | 否 | `1.0` | 新音频音量（0.0-2.0） | `1.0` |

**音量说明：**
- `0.0` = 静音
- `1.0` = 原始音量
- `2.0` = 两倍音量

---

### **4. 硬件加速**

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `use_nvidia` | boolean | 否 | `true` | 是否使用 NVIDIA GPU 加速 |

---

### **5. 字幕配置 (`subtitle`)**

#### **5.1 基础配置**

| 参数 | 类型 | 必填 | 默认值 | 说明 | 可选值 |
|------|------|------|--------|------|--------|
| `enabled` | boolean | 否 | `false` | 是否启用字幕 | `true` / `false` |
| `mode` | string | 否 | `"auto"` | 字幕模式 | `"auto"` / `"manual"` |
| `srt_content` | string | 条件必填 | - | SRT 字幕内容（`mode=manual` 时必填） | SRT 格式文本 |
| `subtitle_language` | string | 否 | `"zh"` | 字幕语言 | `"zh"` / `"en"` / `"ja"` 等 |
| `subtitle_task` | string | 否 | `"transcribe"` | 字幕任务类型 | `"transcribe"` / `"translate"` / `"bilingual"` |
| `translate_manual_srt` | boolean | 否 | `false` | 是否翻译手动提供的 SRT | `true` / `false` |
| `subtitle_engine` | string | 否 | `"whisper"` | 字幕识别引擎 | `"whisper"` / `"funasr"` |

**字幕模式说明：**
- `auto`：自动从视频中识别字幕
- `manual`：使用提供的 `srt_content`

**字幕任务说明：**
- `transcribe`：仅转录（单语字幕）
- `translate`：仅翻译（目标语言字幕）
- `bilingual`：双语字幕（原语言 + 目标语言）

---

#### **5.2 文字样式**

| 参数 | 类型 | 必填 | 默认值 | 说明 | 示例 |
|------|------|------|--------|------|------|
| `style` | string | 否 | `"classic"` | 字幕样式 | `"classic"` / `"karaoke"` / `"highlight"` / `"underline"` / `"word_by_word"` / `"typewriter"` |
| `font_name` | string | 否 | `"Noto Sans CJK SC"` | 字体名称 | `"KingHwa_OldSong"` / `"Arial"` |
| `font_size` | integer | 否 | 自动计算 | 字体大小（12-200） | `48` |
| `primary_color` | string | 否 | `"#FFFFFF"` | 文字颜色（RGB 格式） | `"#FFD700"` |
| `bold` | boolean | 否 | `false` | 是否加粗 | `true` |
| `italic` | boolean | 否 | `false` | 是否斜体 | `true` |
| `underline` | boolean | 否 | `false` | 是否下划线 | `false` |
| `strikeout` | boolean | 否 | `false` | 是否删除线 | `false` |

**字幕样式说明：**
- `classic`：经典样式（静态显示）
- `karaoke`：卡拉OK 样式（逐字高亮）
- `highlight`：高亮样式（逐行高亮）
- `underline`：下划线样式（逐字下划线）
- `word_by_word`：逐字显示
- `typewriter`：打字机效果

---

#### **5.3 描边效果**

| 参数 | 类型 | 必填 | 默认值 | 说明 | 示例 |
|------|------|------|--------|------|------|
| `outline_color` | string | 否 | `"#000000"` | 描边颜色 | `"#8B4513"` |
| `outline_width` | integer | 否 | `2` | 描边宽度（0-10 像素） | `3` |
| `shadow_offset` | integer | 否 | `0` | 阴影偏移（像素） | `2` |

---

#### **5.4 背景框效果**

| 参数 | 类型 | 必填 | 默认值 | 说明 | 示例 |
|------|------|------|--------|------|------|
| `box_color` | string | 否 | `"#000000"` | 背景框颜色 | `"#FFFF00"` |
| `box_opacity` | number | 否 | `0` | 背景框不透明度（0.0-1.0） | `0.6` |
| `box_padding` | integer | 否 | `8` | 背景框边距（0-50 像素） | `10` |

**背景框说明：**
- `box_opacity = 0`：不显示背景框
- `box_opacity > 0`：显示半透明背景框
- `box_opacity = 1.0`：完全不透明背景框

**⚠️ 注意：** 背景框效果与发光效果互斥！

---

#### **5.5 发光效果（动漫风格）**

| 参数 | 类型 | 必填 | 默认值 | 说明 | 示例 |
|------|------|------|--------|------|------|
| `glow_color` | string | 否 | `null` | 发光颜色 | `"#FFFFFF"` / `"#FF1493"` |
| `glow_strength` | integer | 否 | `0` | 发光强度（0-10） | `4` |

**发光强度说明：**
- `0`：不发光
- `1-3`：轻微发光
- `4-6`：中等发光（推荐）
- `7-10`：强烈发光

**⚠️ 注意：** 发光效果与背景框效果互斥！

---

#### **5.6 位置配置**

| 参数 | 类型 | 必填 | 默认值 | 说明 | 可选值 |
|------|------|------|--------|------|--------|
| `position` | string | 否 | `"bottom_center"` | 字幕位置 | `"bottom_left"` / `"bottom_center"` / `"bottom_right"` / `"middle_left"` / `"middle_center"` / `"middle_right"` / `"top_left"` / `"top_center"` / `"top_right"` |
| `margin_v` | integer | 否 | `20` | 垂直边距（像素） | `80` |

---

#### **5.7 其他配置**

| 参数 | 类型 | 必填 | 默认值 | 说明 | 可选值 |
|------|------|------|--------|------|--------|
| `target_lang` | string | 否 | `"zh"` | 目标语言（用于翻译和字体匹配） | `"zh"` / `"en"` / `"th"` / `"ja"` / `"ko"` / `"ar"` 等 |
| `effect` | string | 否 | `"classic"` | 特效样式 | `"classic"` / `"karaoke"` |

**支持的语言代码：**
- `zh`：中文
- `en`：英语
- `th`：泰语
- `ja`：日语
- `ko`：韩语
- `ar`：阿拉伯语
- `vi`：越南语
- `id`：印尼语
- `hi`：印地语
- 等等...

---

### **6. 输出配置 (`output`)**

| 参数 | 类型 | 必填 | 默认值 | 说明 | 示例 |
|------|------|------|--------|------|------|
| `cloud_upload` | boolean | 否 | `true` | 是否上传到云端 | `true` |
| `filename` | string | 否 | `"synced_video.mp4"` | 输出文件名 | `"output_20241206.mp4"` |

---

### **7. Webhook 配置**

| 参数 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| `webhook_url` | string | 否 | 任务完成后的回调 URL | `"https://example.com/webhook"` |
| `id` | string | 否 | 自定义任务 ID | `"task-12345"` |

---

## 🎨 常见配色方案

### **1. 经典黄色背景框**
```json
{
  "subtitle": {
    "primary_color": "#000000",
    "box_color": "#FFFF00",
    "box_opacity": 0.6,
    "box_padding": 8,
    "glow_color": null,
    "glow_strength": 0
  }
}
```

### **2. 动漫风格粉红发光**
```json
{
  "subtitle": {
    "primary_color": "#FFFFFF",
    "glow_color": "#FF1493",
    "glow_strength": 4,
    "outline_width": 2,
    "box_opacity": 0
  }
}
```

### **3. 金色文字 + 白色发光**
```json
{
  "subtitle": {
    "primary_color": "#FFD700",
    "glow_color": "#FFFFFF",
    "glow_strength": 4,
    "outline_color": "#000000",
    "outline_width": 2,
    "bold": true,
    "box_opacity": 0
  }
}
```

### **4. 霓虹灯效果（蓝色发光）**
```json
{
  "subtitle": {
    "primary_color": "#00FFFF",
    "glow_color": "#0080FF",
    "glow_strength": 5,
    "outline_width": 2,
    "box_opacity": 0
  }
}
```

### **5. 火焰风格（橙红渐变）**
```json
{
  "subtitle": {
    "primary_color": "#FFA500",
    "glow_color": "#FF4500",
    "glow_strength": 4,
    "outline_color": "#8B0000",
    "outline_width": 2,
    "box_opacity": 0
  }
}
```

---

## 📊 响应格式

### **成功响应（200 OK）**

```json
{
  "video_url": "https://storage.example.com/bucket/synced_video_20241206.mp4",
  "duration_info": {
    "original_video_duration": 120.5,
    "audio_duration": 125.0,
    "speed_factor": 1.037,
    "final_duration": 125.0
  }
}
```

### **错误响应（400 Bad Request）**

```json
{
  "error": "Font 'InvalidFont' not available.",
  "available_fonts": [
    "Arial",
    "KingHwa_OldSong",
    "Noto Sans CJK SC",
    "Noto Sans Thai"
  ]
}
```

### **错误响应（500 Internal Server Error）**

```json
{
  "error": "FFmpeg processing failed: Invalid video format"
}
```

---

## ⚠️ 重要注意事项

### **1. 参数互斥关系**

**背景框 vs 发光效果：**
- 如果 `box_opacity > 0`，则使用**背景框模式**，`glow_color` 会被忽略
- 如果 `glow_color` 存在且 `box_opacity = 0`，则使用**发光模式**
- **不能同时使用两种效果**

### **2. 颜色格式**

所有颜色参数必须使用 **RGB 十六进制格式**：
- ✅ 正确：`"#FFFFFF"`, `"#FFD700"`, `"#FF1493"`
- ❌ 错误：`"white"`, `"rgb(255,255,255)"`, `"FFFFFF"`

### **3. 字体名称**

字体名称必须与系统中已安装的字体完全匹配（区分大小写）。

**常用字体：**
- `Arial`
- `KingHwa_OldSong`（京华老宋体）
- `Noto Sans CJK SC`（思源黑体简体）
- `Noto Sans Thai`（泰语字体）

**查询可用字体：**
```bash
docker exec ncat fc-list :lang=zh family
```

### **4. 性能优化**

- `glow_strength` 值越大，渲染越慢，推荐范围：3-5
- 高分辨率视频（4K）建议使用较小的 `font_size` 和 `glow_strength`
- 启用 `use_nvidia=true` 可显著提升处理速度

### **5. 文件大小限制**

- 视频文件：建议 < 2GB
- 音频文件：建议 < 500MB
- SRT 文件：建议 < 1MB

---

## 🔧 调试技巧

### **1. 查看日志**

```bash
# 查看最近 200 行日志
docker logs ncat --tail 200

# 实时查看日志
docker logs -f ncat

# 搜索特定关键词
docker logs ncat --tail 500 | grep "box_opacity"
```

### **2. 验证字幕参数**

```bash
# 查看字幕配置日志
docker logs ncat --tail 200 | grep "Subtitle config"

# 查看 ASS Style 日志
docker logs ncat --tail 200 | grep "ASS Style Debug"
```

### **3. 测试字体**

```bash
# 列出所有中文字体
docker exec ncat fc-list :lang=zh family

# 列出所有泰语字体
docker exec ncat fc-list :lang=th family
```

---

## � 快速参考：常用参数组合

### **1. 基础音画同步（无字幕）**
```json
{
  "video": {"url": "视频URL"},
  "audio": {"url": "音频URL"},
  "keep_original_audio": false,
  "new_audio_volume": 1.0,
  "use_nvidia": true,
  "subtitle": {"enabled": false},
  "output": {"cloud_upload": true, "filename": "output.mp4"}
}
```

### **2. 音画同步 + 自动识别中文字幕**
```json
{
  "video": {"url": "视频URL"},
  "audio": {"url": "音频URL"},
  "subtitle": {
    "enabled": true,
    "mode": "auto",                    // 自动识别
    "subtitle_language": "zh",         // 中文
    "subtitle_task": "transcribe",     // 仅转录
    "style": "classic",
    "font_name": "KingHwa_OldSong",
    "primary_color": "#FFFFFF"
  }
}
```

### **3. 手动字幕 + 翻译成泰语（双语）**
```json
{
  "video": {"url": "视频URL"},
  "audio": {"url": "音频URL"},
  "subtitle": {
    "enabled": true,
    "mode": "manual",                  // 手动提供
    "srt_content": "你的SRT内容",
    "translate_manual_srt": true,      // 翻译
    "target_lang": "th",               // 泰语
    "subtitle_task": "bilingual",      // 双语
    "font_name": "KingHwa_OldSong"
  }
}
```

### **4. 黄色背景框字幕**
```json
{
  "subtitle": {
    "enabled": true,
    "primary_color": "#000000",        // 黑色文字
    "box_color": "#FFFF00",            // 黄色背景
    "box_opacity": 0.6,                // 60% 不透明
    "box_padding": 10,                 // 10px 边距
    "glow_strength": 0                 // 不发光
  }
}
```

### **5. 动漫风格发光字幕**
```json
{
  "subtitle": {
    "enabled": true,
    "primary_color": "#FFD700",        // 金黄色文字
    "glow_color": "#FFFFFF",           // 白色发光
    "glow_strength": 4,                // 中等强度
    "bold": true,                      // 加粗
    "box_opacity": 0                   // 不显示背景框
  }
}
```

### **6. 卡拉OK 效果**
```json
{
  "subtitle": {
    "enabled": true,
    "style": "karaoke",                // 卡拉OK 样式
    "effect": "karaoke",               // 卡拉OK 特效
    "primary_color": "#FFFFFF",        // 白色文字
    "glow_color": "#FF1493",           // 粉红发光
    "glow_strength": 5,                // 强烈发光
    "bold": true
  }
}
```

---

## 🎯 参数速查表

| 参数 | 类型 | 默认值 | 说明 | 常用值 |
|------|------|--------|------|--------|
| **音频混合** |
| `keep_original_audio` | boolean | `false` | 保留原音频 | `true` / `false` |
| `original_audio_volume` | number | `0.3` | 原音量 | `0.2-0.5`（背景音） |
| `new_audio_volume` | number | `1.0` | 新音量 | `0.8-1.2`（配音） |
| **字幕基础** |
| `enabled` | boolean | `false` | 启用字幕 | `true` / `false` |
| `mode` | string | `"auto"` | 字幕模式 | `"auto"` / `"manual"` |
| `target_lang` | string | `"zh"` | 目标语言 | `"th"` / `"en"` / `"ja"` |
| `subtitle_task` | string | `"transcribe"` | 字幕任务 | `"bilingual"` / `"translate"` |
| **字幕样式** |
| `font_name` | string | `"Noto Sans CJK SC"` | 字体 | `"KingHwa_OldSong"` / `"Arial"` |
| `font_size` | integer | 自动 | 字体大小 | `28-48` |
| `primary_color` | string | `"#FFFFFF"` | 文字颜色 | `"#FFD700"` / `"#00FFFF"` |
| `bold` | boolean | `false` | 加粗 | `true` / `false` |
| **发光效果** |
| `glow_color` | string | `null` | 发光颜色 | `"#FFFFFF"` / `"#FF1493"` |
| `glow_strength` | integer | `0` | 发光强度 | `3-5`（推荐） |
| **背景框** |
| `box_color` | string | `"#000000"` | 背景颜色 | `"#FFFF00"` |
| `box_opacity` | number | `0` | 不透明度 | `0.5-0.8` |
| `box_padding` | integer | `8` | 边距 | `8-12` |

---

## �📚 相关文档

- [ASS 字幕背景框与发光效果实现文档](./ASS字幕背景框与发光效果实现文档.md)
- [Aegisub ASS 标签文档](http://docs.aegisub.org/3.2/ASS_Tags/)
- [FFmpeg 官方文档](https://ffmpeg.org/documentation.html)

---

## 📞 技术支持

如有问题，请查看日志并提供以下信息：
1. 完整的请求体
2. 错误响应
3. 相关日志（`docker logs ncat --tail 200`）

---

**文档版本：** v1.0  
**最后更新：** 2024-12-06  
**接口版本：** v1
