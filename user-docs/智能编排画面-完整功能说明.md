# 🎬 智能编排画面接口 - 完整功能说明

**接口地址**: `POST /v1/video/audio-with-images`  
**最后更新**: 2025-12-25  
**版本**: v2.0 (Smart Director)

---

## ✨ 核心功能

这是一个**AI驱动的自动视频编辑接口**，能够根据字幕内容智能编排视觉素材，生成专业级视频作品。

### 主要能力：

1. **🧠 智能场景切分**  
   - LLM分析字幕内容，自动识别场景边界
   - 支持中英文语义理解
   - 自动处理长字幕（Token限制保护）

2. **🎨 双匹配模式**  
   - **语义匹配 (match)**：AI根据内容选择最合适的素材
   - **顺序匹配 (order)**：强制按素材顺序使用（适用于预制分镜）

3. **🎬 视觉特效**  
   - **图片模式**：Ken Burns 动态缩放+平移（纪录片级别）
   - **视频模式**：智能变速卡点（Speed Ramping）

4. **🛡️ 健壮容错**  
   - 批量下载：单个文件失败不影响整体
   - 素材处理：单个失败自动跳过
   - 降级保护：LLM失败回退到均匀切分

---

## 📥 请求体结构

### 完整示例（智能模式 - 语义匹配）

```json
{
    "id": "job_20251225_001",
    "webhook_url": "https://callback.myserver.com/api",

    // ===== 必填：视觉素材 =====
    "images": {
        "urls": [
            "https://oss.com/forest_wide.jpg",
            "https://oss.com/man_walking.mp4",
            "https://oss.com/campfire.jpg"
        ]
    },

    // ===== 必填：主音频 =====
    "audio": {
        "url": "https://oss.com/narration.mp3"
    },

    // ===== 可选：背景音乐 =====
    "bg_music": {
        "url": "https://oss.com/sad_piano.mp3",
        "volume": 0.3
    },

    // ===== 核心：字幕（智能模式必需）=====
    "subtitles": "http://oss.com/script.srt",

    // ===== 核心：智能设置 =====
    "settings": {
        "smart": true,           // 【必填】开启智能导演
        "type": "image",         // 【必填】素材类型 (image/video)
        "rule": "match",         // 【必填】匹配规则 (match语义/order顺序)
        
        // 可选参数
        "image_duration": 5,     // 经典模式图片时长(秒)
        "threads": 4,            // 并发线程数
        "use_nvidia": true,      // 是否使用GPU加速
        "bg_music_volume": 0.4   // 背景音音量
    },

    // ===== 可选：输出配置 =====
    "output": {
        "cloud_upload": true,
        "filename": "final_video.mp4"
    }
}
```

### 示例2：顺序匹配模式（预制分镜）

```json
{
    "images": {
        "urls": [
            "https://oss.com/001_opening.mp4",  // 第1幕：开场
            "https://oss.com/002_conflict.mp4", // 第2幕：冲突
            "https://oss.com/003_climax.mp4",   // 第3幕：高潮
            "https://oss.com/004_ending.mp4"    // 第4幕：结局
        ]
    },
    "audio": {
        "url": "https://oss.com/drama.mp3"
    },
    "subtitles": "完整的剧本字幕内容...",
    "settings": {
        "smart": true,      
        "type": "video",    
        "rule": "order"     // 🔴 强制顺序使用
    }
}
```

### 示例3：经典模式（简单轮播）

```json
{
    "images": {
        "bucket": "my-s3-bucket",
        "folder_prefix": "photos/"
    },
    "audio": {
        "url": "https://oss.com/music.mp3"
    },
    "settings": {
        "smart": false,          // 关闭智能模式
        "image_duration": 8,     // 每张图片8秒
        "num_images": 20         // 随机选20张
    }
}
```

---

## 🎯 核心参数说明

| 参数 | 类型 | 必填 | 说明 |
|:---|:---|:---|:---|
| **smart** | bool | 是 | 是否开启智能导演（true=AI卡点，false=简单轮播） |
| **type** | string | 是（smart=true时） | 素材类型：`image`（图片）/ `video`（视频） |
| **rule** | string | 是（smart=true时） | 匹配规则：`match`（AI语义匹配）/ `order`（强制顺序） |
| **subtitles** | string | 是（smart=true时） | SRT字幕内容或URL |

---

## 🚀 技术亮点

### 1. 智能场景识别
- LLM驱动的语义分析
- 自动识别场景边界（不会在句子中间切分）
- 支持1分钟~60分钟字幕（自动分块处理）

### 2. Ken Burns 动态效果
- 随机缩放方向（Zoom In / Zoom Out）
- 5种平移目标（左上、右上、左下、右下、居中）
- 失败自动降级为静态

### 3. 视频智能变速
- 自动计算速度因子（Speed Factor）
- 最大5倍速保护（避免"鬼畜"）
- 超出范围自动切换为裁剪模式

### 4. 下载容错机制
- 素材批量下载支持部分失败
- 单个URL失效不影响整体任务
- 只要≥1个文件成功即可继续

### 5. 多语言支持
- 自动检测中文/英文
- 精准Token估算（中文1.5字符=1 token）
- 避免LLM上下文溢出

---

## ⚠️ 注意事项

1. **素材命名（顺序模式）**  
   如果使用 `rule: "order"`，请确保文件名可排序（如 001.mp4, 002.mp4）

2. **字幕格式**  
   支持标准SRT格式或纯文本（会自动转换）

3. **素材数量限制**  
   建议：3-50个素材最佳  
   - 太少（<3）：场景切换不够丰富
   - 太多（>50）：LLM处理时间长

4. **视频时长控制**  
   系统会自动匹配音频时长，无需额外配置

---

## 📊 返回结果

```json
{
    "video_url": "https://s3.amazonaws.com/.../final_video.mp4",
    "filename": "final_video.mp4",
    "file_size": 15728640,
    "message": "Video creation successful",
    "smart_sync_enabled": true
}
```

---

## 🐛 已知BUG修复记录

- ✅ **参数映射错误**：matching_mode 未正确传递（已修复）
- ✅ **时间计算缺失**：start_time/end_time 未定义（已修复）
- ✅ **Token溢出**：长字幕超出LLM限制（已添加保护）
- ✅ **提示词缺陷**：Sequential模式未强制顺序（已优化）

---

## 🎓 最佳实践

### 场景1：纪录片剪辑
- `smart: true`
- `type: "image"`  
- `rule: "match"`  
→ AI自动根据解说词匹配图片，生成流畅的视觉叙事

### 场景2：分镜脚本执行
- `smart: true`
- `type: "video"`  
- `rule: "order"`  
→ 严格按预制分镜顺序，AI只负责确定每幕时长

### 场景3：快速幻灯片
- `smart: false`  
→ 简单快速，每张图固定时长轮播
