# S3/MinIO ä¸Šä¼ æ¥å£æ–‡æ¡£

## ğŸ“‹ æ¥å£æ¦‚è§ˆ

ç³»ç»Ÿæä¾› **3 ä¸ªä¸Šä¼ æ¥å£**ï¼Œæ”¯æŒä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼š

| æ¥å£ | è·¯å¾„ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| **ç»Ÿä¸€ä¸Šä¼ æ¥å£** | `/v1/s3/upload` | URL/Base64/äºŒè¿›åˆ¶æ•°æ®ä¸Šä¼  |
| **è¡¨å•ä¸Šä¼ æ¥å£** | `/v1/s3/upload-file` | æµè§ˆå™¨è¡¨å•ã€Postman ä¸Šä¼  |
| **æœ¬åœ°æ–‡ä»¶ä¸Šä¼ ** | `/v1/s3/upload-local` | ComfyUI è‡ªåŠ¨åŒ–ã€æœ¬åœ°æ–‡ä»¶ |

---

## 1ï¸âƒ£ ç»Ÿä¸€ä¸Šä¼ æ¥å£ `/v1/s3/upload`

### **æ”¯æŒä¸‰ç§ä¸Šä¼ æ–¹å¼**

#### **æ–¹å¼ 1: URL æµå¼ä¸Šä¼ **

```bash
curl -X POST "http://localhost:8080/v1/s3/upload" \
  -H "x-api-key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "upload_type": "url",
    "file_url": "https://example.com/video.mp4",
    "filename": "videos/my-video.mp4",
    "public": true
  }'
```

#### **æ–¹å¼ 2: Base64 æ•°æ®ä¸Šä¼ ** â­ AI ç”Ÿå›¾ä¸“ç”¨

```bash
curl -X POST "http://localhost:8080/v1/s3/upload" \
  -H "x-api-key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "upload_type": "base64",
    "file_data": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAAB...",
    "filename": "ai-images/generated.png",
    "public": true,
    "content_type": "image/png"
  }'
```

**æ”¯æŒ Data URL æ ¼å¼**ï¼š
```json
{
  "upload_type": "base64",
  "file_data": "data:image/png;base64,iVBORw0KGgo...",
  "filename": "image.png"
}
```

#### **æ–¹å¼ 3: äºŒè¿›åˆ¶æ•°æ®ä¸Šä¼ **

```json
{
  "upload_type": "binary",
  "file_data": "binary data string",
  "filename": "file.bin",
  "content_type": "application/octet-stream"
}
```

### **å‚æ•°è¯´æ˜**

| å‚æ•° | å¿…å¡« | è¯´æ˜ |
|------|------|------|
| `upload_type` | âŒ | ä¸Šä¼ ç±»å‹ï¼š`url`/`base64`/`binary`ï¼Œé»˜è®¤ `url` |
| `file_url` | âœ…* | URL ä¸Šä¼ æ—¶å¿…å¡« |
| `file_data` | âœ…* | Base64/Binary ä¸Šä¼ æ—¶å¿…å¡« |
| `filename` | âŒ | ç›®æ ‡æ–‡ä»¶åï¼ˆå¯å«è·¯å¾„ï¼‰ |
| `public` | âŒ | æ˜¯å¦å…¬å¼€è®¿é—®ï¼Œé»˜è®¤ `false` |
| `content_type` | âŒ | MIME ç±»å‹ |

---

## 2ï¸âƒ£ è¡¨å•ä¸Šä¼ æ¥å£ `/v1/s3/upload-file`

### **multipart/form-data ä¸Šä¼ **

```bash
curl -X POST "http://localhost:8080/v1/s3/upload-file" \
  -H "x-api-key: your-api-key" \
  -F "file=@/path/to/video.mp4" \
  -F "filename=projects/video.mp4" \
  -F "public=true"
```

### **ä»æœ¬åœ°è·¯å¾„ä¸Šä¼ **

```bash
curl -X POST "http://localhost:8080/v1/s3/upload-file" \
  -H "x-api-key: your-api-key" \
  -F "local_path=C:/ComfyUI/output/image.png" \
  -F "filename=ai-images/image.png" \
  -F "public=true"
```

---

## 3ï¸âƒ£ æœ¬åœ°æ–‡ä»¶ä¸Šä¼ æ¥å£ `/v1/s3/upload-local` â­

### **ComfyUI ä¸“ç”¨æ¥å£**

#### **é…ç½®ç¯å¢ƒå˜é‡**

```bash
# .env æ–‡ä»¶
COMFYUI_OUTPUT_PATH=C:/ComfyUI/output
```

#### **ç®€åŒ–è°ƒç”¨ï¼ˆæ¨èï¼‰**

```bash
curl -X POST "http://localhost:8080/v1/s3/upload-local" \
  -H "x-api-key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "source_filename": "ComfyUI_00001_.png",
    "target_filename": "ai-images/2025-12-23/image-001.png",
    "public": true
  }'
```

**ç³»ç»Ÿè‡ªåŠ¨æ‹¼æ¥è·¯å¾„**ï¼š
```
COMFYUI_OUTPUT_PATH + source_filename
= C:/ComfyUI/output/ComfyUI_00001_.png
```

#### **å®Œæ•´è·¯å¾„è°ƒç”¨**

```bash
curl -X POST "http://localhost:8080/v1/s3/upload-local" \
  -H "x-api-key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "local_path": "D:/other-folder/image.png",
    "target_filename": "projects/image.png",
    "public": true
  }'
```

### **å‚æ•°è¯´æ˜**

| å‚æ•° | å¿…å¡« | è¯´æ˜ |
|------|------|------|
| `source_filename` | âœ…* | æºæ–‡ä»¶åï¼ˆéœ€é…ç½® `COMFYUI_OUTPUT_PATH`ï¼‰ |
| `local_path` | âœ…* | å®Œæ•´æ–‡ä»¶è·¯å¾„ï¼ˆä¸ `source_filename` äºŒé€‰ä¸€ï¼‰ |
| `target_filename` | âŒ | MinIO ä¸­çš„ç›®æ ‡è·¯å¾„ï¼Œä¸å¡«åˆ™ç”¨åŸæ–‡ä»¶å |
| `public` | âŒ | æ˜¯å¦å…¬å¼€è®¿é—®ï¼Œé»˜è®¤ `false` |
| `delete_after_upload` | âŒ | ä¸Šä¼ ååˆ é™¤æœ¬åœ°æ–‡ä»¶ï¼Œé»˜è®¤ `false` |

---

## ğŸ¨ n8n é›†æˆç¤ºä¾‹

### **AI ç”Ÿå›¾ + è‡ªåŠ¨ä¸Šä¼ **

```json
{
  "nodes": [
    {
      "name": "AI ç”Ÿå›¾",
      "type": "HTTP Request",
      "parameters": {
        "url": "https://api.imagen.ai/generate",
        "method": "POST"
      }
    },
    {
      "name": "ä¸Šä¼ åˆ° MinIO",
      "type": "HTTP Request",
      "parameters": {
        "url": "http://your-server:8080/v1/s3/upload",
        "method": "POST",
        "headers": {
          "x-api-key": "your-api-key"
        },
        "body": {
          "upload_type": "base64",
          "file_data": "={{$json.image_base64}}",
          "filename": "ai-images/{{$now.format('YYYY-MM-DD')}}/{{$json.prompt}}.png",
          "public": true
        }
      }
    }
  ]
}
```

### **ComfyUI è‡ªåŠ¨ä¸Šä¼ **

```json
{
  "nodes": [
    {
      "name": "ComfyUI ç”Ÿå›¾",
      "type": "HTTP Request"
    },
    {
      "name": "ä¸Šä¼ åˆ° MinIO",
      "type": "HTTP Request",
      "parameters": {
        "url": "http://your-server:8080/v1/s3/upload-local",
        "method": "POST",
        "headers": {
          "x-api-key": "your-api-key"
        },
        "body": {
          "source_filename": "={{$json.output_filename}}",
          "target_filename": "comfyui/{{$now.format('YYYY-MM-DD')}}/{{$json.output_filename}}",
          "public": true
        }
      }
    }
  ]
}
```

---

## ğŸ“Š æ¥å£é€‰æ‹©æŒ‡å—

| åœºæ™¯ | æ¨èæ¥å£ | è°ƒç”¨æ–¹å¼ |
|------|---------|---------|
| **AI ç”Ÿå›¾ API** | `/v1/s3/upload` | Base64 æ¨¡å¼ |
| **è¿œç¨‹æ–‡ä»¶** | `/v1/s3/upload` | URL æ¨¡å¼ |
| **ComfyUI è‡ªåŠ¨åŒ–** | `/v1/s3/upload-local` | ç®€åŒ–æ¨¡å¼ |
| **æµè§ˆå™¨ä¸Šä¼ ** | `/v1/s3/upload-file` | multipart |
| **æœ¬åœ°æ–‡ä»¶æ‰¹é‡ä¸Šä¼ ** | `/v1/s3/upload-local` | å®Œæ•´è·¯å¾„æ¨¡å¼ |

---

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

```bash
# S3/MinIO é…ç½®ï¼ˆå¿…éœ€ï¼‰
S3_ENDPOINT_URL=https://minio.example.com
S3_ACCESS_KEY=your_access_key
S3_SECRET_KEY=your_secret_key
S3_BUCKET_NAME=default-bucket
S3_REGION=us-east-1

# ComfyUI é›†æˆï¼ˆå¯é€‰ï¼‰
COMFYUI_OUTPUT_PATH=C:/ComfyUI/output
```

---

## ğŸ“ å“åº”æ ¼å¼

```json
{
  "status": "success",
  "data": {
    "file_url": "https://minio.example.com/bucket/path/file.png",
    "filename": "path/file.png",
    "bucket": "my-bucket",
    "public": true,
    "size": 123456,
    "content_type": "image/png"
  }
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶å¤¹è‡ªåŠ¨åˆ›å»º**ï¼šMinIO ä¼šè‡ªåŠ¨åˆ›å»ºè·¯å¾„ç»“æ„ï¼Œæ— éœ€æå‰åˆ›å»º
2. **è·¯å¾„åˆ†éš”ç¬¦**ï¼šä½¿ç”¨ `/` è€Œä¸æ˜¯ `\`
3. **Base64 å¤§å°é™åˆ¶**ï¼šå»ºè®®å•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡ 50MB
4. **ç§æœ‰æ–‡ä»¶è®¿é—®**ï¼šè¿”å›çš„é¢„ç­¾å URL é»˜è®¤ 1 å°æ—¶æœ‰æ•ˆæœŸ

---

**ç‰ˆæœ¬**: v2.1  
**æ›´æ–°æ—¥æœŸ**: 2025-12-23
